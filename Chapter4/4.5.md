# 4.5 渐进式rehash

 如果哈希表里保存的键值对数量非常多，那么要一次性将这些键值对全部 rehash 到 `ht[1]` 的话， 庞大的计算量可能会导致服务器在一段时间内停止服务。

因此， 为了避免 rehash 对服务器性能造成影响， 服务器不是一次性将 `ht[0]` 里面的所有键值对全部 rehash 到 `ht[1]` ， 而是分多次、渐进式地将 `ht[0]<` 里面的键值对慢慢地 rehash 到 `ht[1]` 。步骤如下：

1. 为字典`ht[1]`哈希表分配空间
2. 在字典中维持一个索引计数器变量 `rehashidx` ， 并将它的值设置为 **0** ， 表示 rehash 工作正式开始
3. 在 rehash 进行期间， 每次对字典执行增删改查时， 程序除了执行指定的操作以外， 还会顺带将 `ht[0]` 哈希表在 `rehashidx` 索引上的所有键值对 rehash 到 `ht[1]` ， 当 rehash 工作完成之后， 程序将 `rehashidx` 属性的值增一
4.  当`ht[0]` 的所有键值对都被 rehash 至 `ht[1]` ， 这时程序将 `rehashidx` 属性的值设为 **-1**， 表示 rehash 操作已完成

**在渐进式 rehash 的过程中，字典的删除、更新、查找等操作会在两个哈希表上进行，而新增操作一律会保存到ht[1]中。**

>  渐进式rehash执行时，除了根据键值对的操作来进行数据迁移，Redis 本身还会有一个定时任务在执行 rehash，如果没有键值对操作时，这个定时任务会周期性地（例如每100ms一次）搬移一些数据到新的哈希表中，这样可以缩短整个rehash的过程。
>
