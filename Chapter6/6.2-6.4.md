# 6.2-6.4 升级&amp;升级的好处&amp;降级

## 6.2 升级

每当添加一个新元素到整数集合里面， 并且新元素的类型比整数集合现有所有元素的类型都要长时， 整数集合需要先进行升级（upgrade）， 然后才能将新元素添加到整数集合里面。

升级的过程总共分为三步：

1. 根据新元素的类型， 扩展整数集合底层数组的空间大小， 并为新元素分配空间。
2. 将底层数组中现有的所有元素都转换成与新元素相同的类型， 并放置到正确的位上。在放置元素的过程中， 需要维持底层数组的有序性质不变（**从后向前遍历**）。
3. 将新元素添加到底层数组里面。

每次向整数集合添加新元素都可能会引起升级， 而每次升级都需要对数组中所有元素进行类型转换， 所以时间复杂度为 **O(N)** 。

**升级之后新元素的摆放位置：**

因为引发升级的新元素的长度总是比整数集合现有所有元素的长度都大， 所以新元素的值会**大于或小于**所有现有元素：

* 当新元素小于所有现有元素的情况下， 新元素会被放置在底层数组的最开头（索引 **0** ）；
* 在新元素大于所有现有元素的情况下， 新元素会被放置在底层数组的最末尾（索引 **length - 1**）。

>
>

例如：现在有一个 `INTSET_ENC_INT16` 编码的整数集合， 集合中包含三个 1、2、3 三个元素。现将类型为 `int32_t`的整数值 **65535** 添加到整数集合里面。整数集合`contents`数组各个元素及它们所在的位如下：

![image.png](https://gitee.com/zhurundong/picture/raw/master/image-20220319212203-pjr7cmy.png)

**升级步骤图示如下：**

1. **空间重分配**

    ![image.png](https://gitee.com/zhurundong/picture/raw/master/image-20220319212417-3hlxkuu.png)
2. **从后向前，依次将元素放置到正确的位上**

    ![image.png](https://gitee.com/zhurundong/picture/raw/master/image-20220319212542-rpmgtph.png)

    ![image.png](https://gitee.com/zhurundong/picture/raw/master/image-20220319212647-0yo0ave.png)

    ![image.png](https://gitee.com/zhurundong/picture/raw/master/image-20220319212600-r2dysl4.png)
3. **添加新元素 65535 到数组**

    ![image.png](https://gitee.com/zhurundong/picture/raw/master/image-20220319212725-iwcdyj9.png)

## 6.3 升级的好处

**升级的好处主要有两个：**

1. **提升灵活性**

    由于 C 语言是静态类型语言， 为了避免类型错误， 通常不会将两种不同类型的值放在同一个数据结构里面。但是整数集合可以通过自动升级底层数组来适应新元素，所以我们就可以随意地将 `int16_t` 、 `int32_t` 、`int64_t` 类型的整数添加到集合中， 不必担心出现类型错误。
2. **节约内存**

    避免数组都使用 `int64_t` 类型去保存元素， 从而造成内存浪费。

## 6.4 降级

**整数集合不支持降级操作， 一旦对数组进行了升级， 编码就会一直保持升级后的状态。**
