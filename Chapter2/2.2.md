# 2.2 SDS 与 C 字符串的区别

## 常数复杂度获取字符串长度

* C 字符串不记录自身的长度信息， 所以为了获取一个 C 字符串的长度， 程序必须遍历整个字符串，直到遇到代表字符串结尾的空字符为止，这个操作的复杂度为 **O(N)** 。
* SDS 在`len`属性中记录了 SDS 本身的长度，所以获取一个 SDS 长度的复杂度复杂度为 **O(1)**。

设置和更新 SDS 长度的工作是由 SDS 的 API 在执行时自动完成的， 使用 SDS 无须进行任何手动修改长度的工作。

## 杜绝缓冲区溢出

C 字符串不记录自身长度带来的另一个问题是容易造成缓冲区溢出（buffer overflow）。

> 例如，两个在内存中紧邻着的 C 字符串 s1、s2，如果对 s1 执行`stract(s1,"abcdefg")`操作（将abcdefg添加到 s1 的末尾），但是在执行`strcat`操作之前却忘了为 s1 分配足够的空间，那么在 `strcat` 函数执行之后， s1 的数据将溢出到 s2 所在的空间中， 导致 s2 保存的内容被意外地修改。
>

**SDS 的空间分配策略杜绝了缓冲区溢出的可能性：** 当 SDS API 修改 SDS 时，会先检查 SDS 的空间是否满足修改所需的要求，不满足的话，API 会将 SDS 的空间扩展至执行修改所需的大小，然后再执行实际的修改操作。

## 减少修改字符串时带来的内存重分配次数

C 字符串底层的实现是一个 **N+1** 个字符长的数组（包含一个空字符）。因此，C 字符串的长度和底层数组长度存在着这种关联性，每次增长或缩短一个 C 字符串，程序都要对保存这个 C 字符串的数组进行一次内存重分配操作：

* 增长字符串操作，在执行操作之前，程序需要先通过内存重分配来扩展底层数组的空间大小，否则，就会产生缓冲区溢出。
* 缩短字符串操作，在执行操作之前，程序需要先通过内存重分配来释放字符串不再使用的那部分空间，否则，就会产生内存泄漏。

Redis 作为数据库， 经常被用于速度要求严苛、数据被频繁修改的场合， 如果每次修改字符串的长度都需要执行一次内存重分配的话，可能还会对性能造成影响。

所以，SDS 通过未使用空间解除了字符串长度和底层数组长度之间的关联： 在 SDS 中， `buf` 数组的长度不一定就是字符数量加一， 数组里面可以包含未使用的字节， 而这些字节的数量就由 SDS 的 `free` 属性记录。

通过未使用空间，SDS 实现了空间预分配和惰性空间释放两种优化策略：

### 空间预分配

用于优化 SDS 的字符串增长操作： 当对一个 SDS 进行修改， 并且需要对 SDS 进行空间扩展的时候， 程序不仅会为 SDS 分配修改所必须要的空间， 还会为 SDS 分配额外的未使用空间。

 额外分配的未使用空间数量由以下公式决定：

* 对 SDS 修改之后，SDS 的长度（`len` 属性的值）小于 **1 MB**， 那么程序分配和 `len` 属性同样大小的未使用空间， 这时 SDS `slen` 属性的值将和 `free` 属性的值相同（例如 SDS 修改后长度 为 10 字节，那么 buf 数组长度变为：10 + 10 + 1 = 21 字节）。
* 对 SDS 修改之后，SDS 的长度（`len` 属性的值）大于 **1 MB**， 那么程序分配 **1 MB** 的未使用空间（例如 SDS 修改后长度 为 30 MB，那么 buf 数组长度变为：30 MB+ 1 MB + 1byte）。

### 惰性空间释放

用于优化 SDS 的字符串缩短操作：当 SDS 的 API 需要缩短 SDS 保存的字符串时， 程序并不立即使用内存重分配来回收缩短后多出来的字节， 而是使用 `free` 属性将这些字节的数量记录起来， 并等待将来使用。

此外， SDS 也提供了相应的 API ，可以真正地释放 SDS 里面的未使用空间， 防止因惰性空间释放策略而造成的内存浪费。

## 二进制安全

C 字符串中的字符必须符合某种编码（比如 ASCII）， 并且除了字符串的末尾之外， 字符串里面不能包含空字符， 这些限制使得 C 字符串只能保存文本数据， 而不能保存像图片、音频、视频、压缩文件这样的二进制数据。

SDS 的 API 都是二进制安全的（binary-safe），SDS API 会以处理二进制的方式来处理 SDS 存放在 `buf` 数组里的数据， 程序不会对其中的数据做任何限制、过滤，数据在写入时是什么样的， 它被读取时就是什么样。

## 兼容部分 C 字符串函数

SDS 的 API 都是二进制安全的， 但它们遵循 C 字符串以空字符结尾的惯例，这样，SDS 就可以重用<string.h>函数库， 从而避免了不必要的代码重复。

## 总结

|C 字符串|SDS|
| ----------------------------------------------| ----------------------------------------------|
|获取字符串长度的复杂度为 O(N)|获取字符串长度的复杂度为 O(1)|
|API 不安全，可能会造成缓冲区溢出|API 安全，不会造成缓冲区溢出|
|修改字符串长度 N 次，必须执行 N 次内存重分配|修改字符串长度 N 次，最后执行 N 次内存重分配|
|只能保存文本|可以保存文本和二进制数据|
|可使用所有<string.h>库的函数|可使用部分<string.h>库的函数|
