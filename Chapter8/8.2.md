# 8.2 字符串对象

字符串对象的编码可以是`int`、`raw`、`embstr`。

* 字符串对象保存的是一个可以用 **long** 类型表示的整数值，那么字符串对象会将整数值保存在字符串对象结构的`ptr`属性里面（将 void* 装转换成 long），并将字符串编码设置为 `int`；
* 字符串对象保存的是一个长度大于 **39** 字节的字符串值，那么字符串对象将使用 SDS 来保存这个字符串值，并将字符串编码设置为 `raw`；
* 字符串对象保存的是一个长度小于等于 **39** 字节的字符串值，那么字符串对象将使用 `embstr`编码方式来保存这个字符串值。

`embstr`编码是专门用于保存短字符串的一种优化编码方式， 它和 `raw` 编码一样， 都使用 `redisObject`结构和`sdshdr`结构来表示字符串对象， 但`raw`编码会调用两次内存分配函数来分别创建`redisObject`结构和`sdshdr`结构， 而`embstr`编码则通过调用一次内存分配函数来分配一块连续的空间， 空间中依次包含 `redisObject`和`sdshdr`两个结构，如下所示：

|redisObject||||sdshdr|||
| ---------------| -----| ------| -----| ----------| --| --|
|type|encoding|ptr|...|free|len|buf|

使用 `embstr` 编码的字符串对象来保存短字符串值的好处有：

1. 内存分配次数从`raw`编码的两次降低为一次
2. 内存释放也只需要调用一次内存释放函数
3. 由于内存连续，可以更好地利用缓存带来的优势

Redis 中 **long、double** 类型的浮点数也是作为字符串值来保存的，程序会先将这个浮点数转换成字符串值， 然后再保存起转换所得的字符串值。

**字符串对象保存各类型值的编码方式：**

|**值**|**编码**|
| --------------------------------------------------------------------------------------------------------------| ---------------------|
|用 **long** 类型保存的整数。|`int`|
|用 **long、double** 类型保存的浮点数|`embstr`或`raw`|
|字符串值， 因为长度太大而没办法用**long** 类型表示的整数及**long、double**类型表示的浮点数|`embstr`或`raw`|

## 8.2.1 编码的转换

`int`编码的字符串对象和`embstr` 编码的字符串对象在条件满足的情况下， 会被转换为`raw` 编码的字符串对象。例如：

1. 对`int`编码的字符串对象执行一些命令，使其不再是整数值，而是字符串值，那么编码将从`int`变为`raw`。如 APPEND；
2. 对`embstr`编码的字符串，执行任何修改命令，程序会先将对象编码从`embstr`转换成`raw`，再执行修改命令。如 APPEND。

## 8.2.2 字符串命令的实现

因为字符串键的值为字符串对象，所以用于字符串键的所有命令都是针对字符串对象来构建的，下表为一些字符串命令以及这些命令在不同编码的字符串对象下的实现方法。

|命令|`int` 编码的实现方法|`embstr` 编码的实现方法|`raw` 编码的实现方法|
| :------------| :--------------------------------------------------------------------------------------------------------------------------| :-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------| :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|SET|使用 `int` 编码保存值。|使用 `embstr` 编码保存值。|使用 `raw` 编码保存值。|
|GET|拷贝对象所保存的整数值，将这个拷贝转换成字符串值，然后向客户端返回这个字符串值。|直接向客户端返回字符串值。|直接向客户端返回字符串值。|
|APPEND|将对象转换成 `raw` 编码，然后按 `raw` 编码的方式执行此操作。|将对象转换成 `raw` 编码，然后按 `raw` 编码的方式执行此操作。|调用 `sdscatlen` 函数， 将给定字符串追加到现有字符串的末尾。|
|INCRBYFLOAT|取出整数值并将其转换成 `long double` 类型的浮点数， 对这个浮点数进行加法计算， 然后将得出的浮点数结果保存起来。|取出字符串值并尝试将其转换成 `long double` 类型的浮点数， 对这个浮点数进行加法计算， 然后将得出的浮点数结果保存起来。 如果字符串值不能被转换成浮点数，那么向客户端返回一个错误。|取出字符串值并尝试将其转换成 `long double` 类型的浮点数， 对这个浮点数进行加法计算， 然后将得出的浮点数结果保存起来。 如果字符串值不能被转换成浮点数， 那么向客户端返回一个错误。|
|INCRBY|对整数值进行加法计算，得出的计算结果会作为整数被保存起来。|`embstr` 编码不能执行此命令，向客户端返回一个错误。|`raw` 编码不能执行此命令， 向客户端返回一个错误。|
|DECRBY|对整数值进行减法计算，得出的计算结果会作为整数被保存起来。|`embstr` 编码不能执行此命令，向客户端返回一个错误。|`raw` 编码不能执行此命令， 向客户端返回一个错误。|
|STRLEN|拷贝对象所保存的整数值，将这个拷贝转换成字符串值，计算并返回这个字符串值的长度。|调用 `sdslen` 函数， 返回字符串的长度。|调用 `sdslen` 函数， 返回字符串的长度。|
|SETRANGE|将对象转换成 `raw` 编码， 然后按 `raw` 编码的方式执行此命令。|将对象转换成 `raw` 编码，然后按 `raw` 编码的方式执行此命令。|将字符串特定索引上的值设置为给定的字符。|
|GETRANGE|拷贝对象所保存的整数值， 将这个拷贝转换成字符串值， 然后取出并返回字符串指定索引上的字符。|直接取出并返回字符串指定索引上的字符。|直接取出并返回字符串指定索引上的字符。|
